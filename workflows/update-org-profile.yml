name: ğŸ“Š Update Organization Profile

on:
  workflow_run:
    workflows: ["ğŸ¯ E2E Tests & Report"]
    types: [completed]
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • ì—…ë°ì´íŠ¸
  workflow_dispatch:

jobs:
  update-profile:
    name: ğŸ“ˆ Update Org Profile Stats
    runs-on: ubuntu-latest
    if: github.repository == 'sesac7-hello-pet-v2/hello-pet-v2'

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.ORG_PROFILE_TOKEN }}  # í•„ìš” ì‹œ ì„¤ì •
        repository: 'sesac7-hello-pet-v2/.github'

    - name: ğŸ“Š Update README with test results
      run: |
        # í…ŒìŠ¤íŠ¸ ê²°ê³¼ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
        TEST_STATUS=$(curl -s "https://api.github.com/repos/sesac7-hello-pet-v2/hello-pet-v2/actions/workflows/e2e-test.yml/runs?per_page=1" | jq -r '.workflow_runs[0].conclusion')
        RUN_DATE=$(curl -s "https://api.github.com/repos/sesac7-hello-pet-v2/hello-pet-v2/actions/workflows/e2e-test.yml/runs?per_page=1" | jq -r '.workflow_runs[0].updated_at')

        # README.md ì—…ë°ì´íŠ¸ (ë§ˆì»¤ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ì„¹ì…˜ë§Œ ì—…ë°ì´íŠ¸)
        sed -i '/<!-- E2E_STATS_START -->/,/<!-- E2E_STATS_END -->/c\
        <!-- E2E_STATS_START -->\
        ## ğŸ§ª E2E í…ŒìŠ¤íŠ¸ í˜„í™©\
        \
        [![E2E Tests](https://github.com/sesac7-hello-pet-v2/hello-pet-v2/actions/workflows/e2e-test.yml/badge.svg)](https://github.com/sesac7-hello-pet-v2/hello-pet-v2/actions/workflows/e2e-test.yml)\
        \
        **ğŸ“Š [ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸](https://sesac7-hello-pet-v2.github.io/hello-pet-v2/)**\
        \
        - **ë§ˆì§€ë§‰ ì‹¤í–‰**: '"$RUN_DATE"'\
        - **ìƒíƒœ**: '"$TEST_STATUS"'\
        - **í…ŒìŠ¤íŠ¸ í™˜ê²½**: Playwright + Chromium\
        <!-- E2E_STATS_END -->' README.md

    - name: ğŸ’¾ Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ“Š Update E2E test stats"
        git push